<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>密码重置 - 网页时钟聊天室</title>
    <link rel="stylesheet" href="style.css">
    <!-- 添加Supabase客户端库 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- 密码重置页面 -->
    <div id="reset-password-container" class="container">
        <h1>密码重置</h1>
        
        <!-- 步骤1：输入邮箱 -->
        <div id="step-email" class="reset-password-form">
            <h2>重置您的密码</h2>
            <p>请输入您注册时使用的邮箱地址，我们将向您发送密码重置链接。</p>
            
            <div class="form-group">
                <label for="email">邮箱地址：</label>
                <input type="email" id="email" placeholder="请输入您的邮箱地址">
            </div>
            
            <div class="form-actions">
                <button id="send-reset-link-btn" class="save-button">发送重置链接</button>
                <button id="back-to-home-btn" class="register-button">返回首页</button>
            </div>
        </div>
        
        <!-- 步骤2：密码重置表单 (默认隐藏) -->
        <div id="step-reset" class="reset-password-form hidden">
            <h2>设置新密码</h2>
            <p>请设置您的新密码。密码至少需要6位字符。</p>
            
            <div class="form-group">
                <label for="new-password">新密码：</label>
                <input type="password" id="new-password" placeholder="请输入新密码">
            </div>
            
            <div class="form-group">
                <label for="confirm-password">确认新密码：</label>
                <input type="password" id="confirm-password" placeholder="请再次输入新密码">
            </div>
            
            <div class="form-actions">
                <button id="reset-password-btn" class="save-button">重置密码</button>
                <button id="back-to-email-btn" class="register-button">返回</button>
            </div>
        </div>
        
        <!-- 成功消息 (默认隐藏) -->
        <div id="success-message" class="success-message hidden">
            <h3>✅ 操作成功！</h3>
            <p id="success-text">密码重置链接已发送到您的邮箱，请查收。</p>
            <div class="form-actions">
                <button id="back-btn" class="save-button">返回首页</button>
            </div>
        </div>
        
        <!-- 错误消息 (默认隐藏) -->
        <div id="error-message" class="error-message hidden">
            <h3>❌ 操作失败</h3>
            <p id="error-text">操作过程中发生错误，请稍后再试。</p>
            <div class="form-actions">
                <button id="try-again-btn" class="save-button">重试</button>
            </div>
        </div>
    </div>
    
    <script>
        // 初始化Supabase客户端
        const supabaseConfig = {
            url: 'https://ylzhswdqigqnrqfvtayi.supabase.co', // Supabase项目URL
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlsemhzd2RxaWdxbnJxZnZ0YXlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNTY2ODcsImV4cCI6MjA3MzczMjY4N30.GOESBmkHwI_nZNVtjJ5lC9P9EnGwbnpYy7l-HZX2HVE' // Supabase API密钥
        };
        
        let supabase = null;
        let resetToken = '';
        
        // 初始化Supabase客户端
        function initializeSupabase() {
            if (typeof window !== 'undefined' && window.supabase && window.supabase.createClient) {
                try {
                    const client = window.supabase.createClient(supabaseConfig.url, supabaseConfig.key);
                    return client;
                } catch (error) {
                    console.error('创建Supabase客户端失败:', error.message);
                    return null;
                }
            }
            return null;
        }
        
        // 检查Supabase是否可用
        function isSupabaseAvailable() {
            return supabase !== null;
        }
        
        // 验证邮箱格式
        function isValidEmail(email) {
            const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
            return emailRegex.test(email);
        }
        
        // 发送密码重置链接
        async function sendResetPasswordLink() {
            supabase = initializeSupabase();
            
            const email = document.getElementById('email').value.trim();
            
            if (!email || !isValidEmail(email)) {
                alert('请输入有效的邮箱地址');
                return;
            }
            
            if (!isSupabaseAvailable()) {
                alert('服务暂时不可用，请稍后再试。');
                return;
            }
            
            try {
                // 调用Supabase的发送重置密码链接API
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: `${window.location.origin}/reset-password.html`
                });
                
                if (error) {
                    console.error('发送重置链接失败:', error.message);
                    alert(`发送失败：${error.message}`);
                    return;
                }
                
                // 显示成功消息
                document.getElementById('step-email').classList.add('hidden');
                document.getElementById('success-text').textContent = '密码重置链接已发送到您的邮箱，请查收。';
                document.getElementById('success-message').classList.remove('hidden');
                
            } catch (err) {
                console.error('发送过程中发生异常:', err.message);
                alert('发送过程中发生错误，请稍后再试。');
            }
        }
        
        // 重置密码
        async function resetPassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // 密码验证
            if (!newPassword || newPassword.length < 6) {
                alert('密码至少需要6位字符');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('两次输入的密码不一致');
                return;
            }
            
            if (!isSupabaseAvailable()) {
                alert('服务暂时不可用，请稍后再试。');
                return;
            }
            
            try {
                // 从URL获取token
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token') || '';
                
                if (!token) {
                    alert('无效的重置链接，请重新请求密码重置。');
                    return;
                }
                
                // 使用Supabase的updateUser方法重置密码
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });
                
                if (error) {
                    console.error('重置密码失败:', error.message);
                    alert(`重置失败：${error.message}`);
                    return;
                }
                
                // 显示成功消息
                document.getElementById('step-reset').classList.add('hidden');
                document.getElementById('success-text').textContent = '密码已成功重置，请使用新密码登录。';
                document.getElementById('success-message').classList.remove('hidden');
                
            } catch (err) {
                console.error('重置过程中发生异常:', err.message);
                alert('重置过程中发生错误，请稍后再试。');
            }
        }
        
        // 检查URL中是否有重置token
        function checkResetToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                // 有token，显示密码重置表单
                document.getElementById('step-email').classList.add('hidden');
                document.getElementById('step-reset').classList.remove('hidden');
                resetToken = token;
            }
        }
        
        // 页面加载时执行
        document.addEventListener('DOMContentLoaded', () => {
            checkResetToken();
            
            // 发送重置链接按钮点击事件
            document.getElementById('send-reset-link-btn').addEventListener('click', sendResetPasswordLink);
            
            // 返回首页按钮点击事件
            document.getElementById('back-to-home-btn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });
            
            // 重置密码按钮点击事件
            document.getElementById('reset-password-btn').addEventListener('click', resetPassword);
            
            // 返回邮箱输入步骤按钮点击事件
            document.getElementById('back-to-email-btn').addEventListener('click', () => {
                document.getElementById('step-reset').classList.add('hidden');
                document.getElementById('step-email').classList.remove('hidden');
            });
            
            // 成功消息中的返回首页按钮点击事件
            document.getElementById('back-btn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });
            
            // 错误消息中的重试按钮点击事件
            document.getElementById('try-again-btn').addEventListener('click', () => {
                document.getElementById('error-message').classList.add('hidden');
                document.getElementById('step-email').classList.remove('hidden');
            });
        });
    </script>
</body>
</html>